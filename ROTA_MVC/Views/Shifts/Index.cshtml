@model IEnumerable<ROTA_MVC.Models.ShiftDto> 
@using System.Security.Claims

@{
    ViewData["Title"] = "Shift List";
    DateTime startDate = ViewBag.StartDate ?? DateTime.UtcNow.Date.AddDays(-(int)DateTime.UtcNow.DayOfWeek); // Default start of week
    DateTime endDate = ViewBag.EndDate ?? startDate.AddDays(6); // Default end of week
    int? employeeIdFilter = ViewBag.EmployeeIdFilter;
    bool isAdmin = User.IsInRole("Admin"); // Check role once
}

@* --- Page Header --- *@
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">@ViewData["Title"]</h1>
     <div class="btn-toolbar mb-2 mb-md-0">
         <a asp-action="Calendar" class="btn btn-sm btn-outline-secondary me-2"> @* Link back to calendar *@
             <i class="bi bi-calendar-week me-1"></i> Calendar View
         </a>
         @if (isAdmin) {
             <a asp-action="Create" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-circle me-1"></i>Assign New Shift
             </a>
         }
    </div>
</div>

@if (TempData["ErrorMessage"] != null) { <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">@TempData["ErrorMessage"]<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div> }

@* --- Filter Form Card --- *@
<div class="card shadow-sm mb-4">
    <div class="card-body p-3">
        <form asp-action="Index" method="get" class="row g-3 align-items-end">
            <div class="col-md-3 col-lg-3">
                <label for="startDate" class="form-label small fw-medium">Start Date</label>
                <input type="date" id="startDate" name="startDate" value="@startDate.ToString("yyyy-MM-dd")" class="form-control form-control-sm" />
            </div>
            <div class="col-md-3 col-lg-3">
                <label for="endDate" class="form-label small fw-medium">End Date</label>
                <input type="date" id="endDate" name="endDate" value="@endDate.ToString("yyyy-MM-dd")" class="form-control form-control-sm" />
            </div>
             @if (isAdmin) { @* Only show employee filter for admins on list view? Or always? Adjust as needed *@
                 <div class="col-md-4 col-lg-4">
                    <label for="employeeId" class="form-label small fw-medium">Employee</label>
                    <select id="employeeId" name="employeeId" asp-items="ViewBag.EmployeeList" class="form-select form-select-sm">
                        <option value="">-- All Employees --</option>
                    </select>
                 </div>
             } else {
                  <div class="col-md-4 col-lg-4"></div> @* Placeholder *@
             }

            <div class="col-12 col-lg-auto ms-lg-auto mt-3 mt-lg-0">
                <div class="d-grid d-lg-flex gap-2">
                    <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-funnel-fill me-1"></i>Filter</button>
                    <a asp-action="Index" class="btn btn-outline-secondary btn-sm"><i class="bi bi-x-lg me-1"></i>Clear</a>
                </div>
            </div>
        </form>
    </div>
</div>

@* --- Shift Table Card --- *@
<div class="card shadow-sm">
     <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Scheduled Shifts</h5>
    </div>
    <div class="table-responsive">
        <table class="table table-hover table-striped table-sm mb-0">
            <thead class="text-body-secondary small text-uppercase">
                <tr>
                    <th scope="col" class="ps-3">Employee</th>
                    <th scope="col">Team</th>
                    <th scope="col">Shift Type</th>
                    <th scope="col" class="text-center">On Call</th>
                    <th scope="col">Start</th>
                    <th scope="col">End</th>
                    <th scope="col">Notes</th>
                    <th scope="col" class="text-end pe-3">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Any())
                {
                    <tr><td colspan="8" class="text-center text-muted p-4"><i>No shifts found matching the criteria.</i></td></tr>
                }
                @foreach (var item in Model.OrderBy(s => s.ShiftStartDateTime).ThenBy(s => s.EmployeeLastName).ThenBy(s => s.EmployeeFirstName)) // Order by start, then name
                {
                    <tr>
                        <td class="ps-3 align-middle">@item.EmployeeFullName</td>
                        <td class="align-middle">@(string.IsNullOrWhiteSpace(item.TeamName) ? Html.Raw("<span class='text-muted'>-</span>") : item.TeamName)</td>
                        <td class="align-middle">@item.ShiftTypeName</td>
                        <td class="text-center align-middle">
                             @if(item.IsOnCall) { <i class="bi bi-check-circle-fill text-danger" title="Yes, On Call"></i> }
                             else { <span class="text-muted">-</span> }
                        </td>
                        <td class="align-middle">@item.ShiftStartDateTime.ToLocalTime().ToString("g")</td> @* Short date/time *@
                        <td class="align-middle">@item.ShiftEndDateTime.ToLocalTime().ToString("g")</td>
                        <td class="align-middle text-truncate" style="max-width: 150px;" title="@item.Notes"> @* Truncate long notes *@
                            @(string.IsNullOrWhiteSpace(item.Notes) ? Html.Raw("<span class='text-muted'>-</span>") : item.Notes)
                        </td>
                        <td class="text-end pe-3 align-middle">
                             <div class="btn-group btn-group-sm">
                                <a asp-action="Details" asp-route-id="@item.ShiftId" class="btn btn-outline-info" title="View Details"><i class="bi bi-eye"></i></a>
                                @if (User.IsInRole("Admin"))
                                {
                                    <a asp-action="Edit" asp-route-id="@item.ShiftId" class="btn btn-outline-secondary ms-1" title="Edit Shift"><i class="bi bi-pencil"></i></a>
                                    <a asp-action="Delete" asp-route-id="@item.ShiftId" class="btn btn-outline-danger ms-1" title="Delete Shift"><i class="bi bi-trash3"></i></a>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>@* End table-responsive *@
</div> @* End Card *@